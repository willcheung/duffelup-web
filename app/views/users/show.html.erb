<noscript>
  <div id="announcement">
  <div class="javascript_disabled_notification">
    <div class="inner">
      <h1>You need to enable Javascript in your web browser!</h1><br />
      <p>Duffel requires a browser feature called <strong>JavaScript</strong> for everything to work correctly.</p>
      <p>Please see: <a href="http://www.google.com/support/bin/answer.py?answer=23852">How to enable JavaScript in your browser</a>.</p>
      <p>Once you've enabled JavaScript you can <a href="">try loading this page again</a>.</p>
    <p>-- Duffel Team</p>
    </div>
  </div>
  </div>
</noscript>

<%= render :partial => "announcements/announcements" unless current_announcements.empty? -%> 

<% if logged_in? and (current_user.email.nil? or current_user.email.blank?) %>
<div id="announcement" style="border: 3px solid #e0e0e0">
<h1>Hi there! We picked a username for you - <%= current_user.username %></h1><br/>
<p>You can change it anytime. Please take a few seconds to <a href="/user/edit">update your profile</a> so we can give you a better Duffel experience.</p>
</div>
<% end %>

<div id="primary-inner">

  <div id="sidebar-profile">

    <div id="userProfile">
      <div class="avatar">
        <a href="/<%= current_user.username %>"> <%= display_thumbnail(current_user) %></a>
      </div>
      <div class="profile">
        <em><%= link_to display_user_name(current_user), profile_url(current_user.username) %></em>
        <cite style="color:#999;"><%= current_user.home_city.gsub(", United States", "") unless current_user.home_city.nil? %></cite>
        <% if founding_member?(current_user) %><cite style="color:#FFD700;">Founding Member</cite><% end %>
		<span class="edit-link" style="float:left;margin-top:5px;"><%= link_to "Edit", edit_user_url %></span>
      </div>
    </div> <!-- #userProfile -->

    <div id="userStats">
      <dl>
        <dt>User Stats</dt>
        <!--<dd><%= link_to(pluralize(@friends.size, "Friend"), :controller => "users", :action => "search", :q => "friend:#{current_user.username}") %></dd>-->
        <dd><%= pluralize(@total_favorite_count, "Person")%> Faved Your Duffels</dd>
		<dd><%= pluralize((@planned_trips.size+@no_date_trips.size), "Active Duffel") %></dd>
        <dd><%= pluralize(@favorite_trips.size, "Favorite Duffel") %></dd>
      </dl>
    </div> <!-- #userStats -->

<%- if @duffel_of_the_month -%>
	<% cache("dashboard-featured-duffel") do %>
    <div id="featuredUser">
      <h2>Featured Duffels</h2>
      <div class="avatar">
       	<% if !@duffel_of_the_month.trip.photo.size.nil? and @duffel_of_the_month.trip.photo.size != "" %>
		<span><a href="<%=trip_path(@duffel_of_the_month.trip)%>"><img max-width="240" src="<%= @duffel_of_the_month.trip.photo.url(:small) %>" class="duffel-image" /></a></span>
		<% elsif !@duffel_of_the_month.trip.photo_file_name.nil? %>
		<span><a href="<%=trip_path(@duffel_of_the_month.trip)%>"><img max-width="240" src="<%=@duffel_of_the_month.trip.photo_file_name.gsub("_s.jpg", "_m.jpg") %>" class="duffel-image" /></a></span>
		<% end %>
      </div>
      <div class="profile">
        <em><a href="<%=trip_path(@duffel_of_the_month.trip)%>"><%=truncate(@duffel_of_the_month.trip.title, :length => 28)%></a></em>
        <cite style="font-size:12px;color:#888"><%= @duffel_of_the_month.trip.destination.split(";")[0] %></cite>
		<cite style="margin-top:5px">
			<small><span class="cf-favorite" style="display:inline;padding:5px 5px 0 25px"><%=pluralize(@duffel_of_the_month.trip.favorites.size, "Fave")%></span>
			<span class="cf-comment" style="display:inline;padding:5px 5px 0 25px"><%=pluralize(@duffel_of_the_month.trip.comments.size, "Comment")%></span> </small>
		</cite>
      </div>
      <div class="description">
		<span style="font-size:12px; padding-top:5px">
 
		Organized by <a href="/<%= @duffel_of_the_month.trip.admins[0].username %>"> <%= @duffel_of_the_month.trip.admins[0].username %></a>
		<% if @duffel_of_the_month.trip.users.count > 1 %>
			and <%= pluralize(@duffel_of_the_month.trip.users.count, "other tripgoer") %>
		<% end %>

		</span>
		<span><a style="color:#F20063" href="/featured">View more &raquo;</a></span>

      </div>
    </div> <!-- #featuredUser -->
	<% end %>
<%- end -%>

	<% unless @requested_friends.empty? %>
	<div class="section" id="friends-request">
		<%= render :partial => 'profile/requested_friends' -%>
	</div>
	<% end %>

 	<div id="friends">
      <h2>Friends</h2>
      <ul>
		<% @friends.each_with_index do |f,i| %>
			<% break if i== 16 %>
			<dl><dd><li><%= link_to display_thumbnail(f), profile_for(f), :title => display_thumbnail_title(f.username, f.full_name, f.home_city) %></li></dl></dd>
		<% end %>
		<% if @friends.size >= 16 %>
			<div class="clearfix"></div>
			<%= link_to "View all &raquo;", {:controller => "users", :action => "search", :q => "friend:#{current_user.username}"}, :style => "margin-top:5px" %>
		<% end %>
      </ul>
    </div> <!-- #friends -->

	<h2 style="margin-bottom:0;">Follow Travel Deals <small style="font-weight:normal;">- <a href="#" onclick="$('following').toggle();return false;">Edit</a></small></h2>
	<div id="travelDeals">
	</div>

	<div style="margin: 20px 0">
		<a href="http://itunes.apple.com/app/id371064516" target="_blank" alt="Duffel Up and Go iPhone App" title="Duffel Up and Go iPhone App"><img src="/images/iphone_banner.jpg" style="width:210px"></a>
	</div>
    
  </div> <!-- #sidebar-profile -->

  <div id="mainContent">
	
	<div id="dashboard-header">
		<% if (!params[:tab] or params[:tab] == "updates") and (@planned_trips.size > 0 or @no_date_trips.size > 0) and !@preview_duffel.nil? %>
		<div id="active-duffel-reminder">
			<h2>Most recent duffel: <span class="mute t11"><a href="?tab=duffels-active">(manage active duffels)</a></span></h2>
			<div id="photo-container"><a href="/trips/<%= @preview_duffel.permalink %>"><img src="<%= duffel_thumbnail_url(@preview_duffel) %>" alt="<%= @preview_duffel.title %>" title="<%= @preview_duffel.title %>"/></a></div>
			
			<div id="title">
				<%= link_to h(truncate(@preview_duffel.title, :length => Trip::DASHBOARD_TITLE_TRUNCATE_SIZE)), trip_url(:id => @preview_duffel) %>
			</div>
			
			<div id="details">
				<span>
				<strong><%= @all_trips_favorite_count[@preview_duffel.id.to_s].nil? ? 0 : @all_trips_favorite_count[@preview_duffel.id.to_s] %></strong> Faves,
				<strong><%= @preview_duffel.comment_count %></strong> Comments
				</span>
			</div>
			
			<div id="destination"><%= h(truncate(shorten_trip_destination(@preview_duffel.destination), :length => Trip::DASHBOARD_DESTINATION_TRUNCATE_SIZE)) %></div>
		    <div id="date" class="mute" style="padding-bottom:6px"><em><%= display_trip_dates(@preview_duffel.start_date,@preview_duffel.end_date) %></em></div>

		</div>
		<div class="clearfix"></div>
		<% end %>
		
		<div id="new-duffel-form" <% if (!params[:tab] or params[:tab] == "updates") and (@planned_trips.size > 0 or @no_date_trips.size > 0) and !@preview_duffel.nil? %>style="display:none;"<% end %>>
			<h2>I'm planning to visit:</h2>
			<% form_for(:trip_city, :html => {:id => "trip_form"}, :url => new_trip_url) do |f| %>
				<%= text_field_with_auto_complete :trip, :destination, { :class => "trip_destination big", :onblur => "if(this.value=='')this.value='e.g. Rome, Italy';", :onfocus => "if(this.value=='e.g. Rome, Italy')this.value=''", :value => "e.g. Rome, Italy" }, { :indicator => "indicator", :frequency => ".2", :min_chars => "3" } %>
				<%= submit_tag "Create Duffel", :class => "submit big-button" %>
				<span id="indicator" style="display:none"><img class="indicator" src="/images/ajax-loader.gif" alt="loading" /></span>
			<% end %>
		</div>
	</div>
	
	<div id="dashboard_tabs">
		<ul class="tabnav">
			<li id="tb-updates" <% if params[:tab] == "updates" or params[:tab].nil? %>class="selected"<% end %> onclick="location.search='tab=updates';$(this).addClassName('selected');$('tb-duffels').removeClassName('selected');$('tb-deals').removeClassName('selected'); $('loading-spinner').show(); return false;">
				<a href="#">Recent Updates</a>
			</li>
			<li id="tb-duffels" <% if params[:tab] == "duffels-previous" or params[:tab] == "duffels-faves" or params[:tab] == "duffels-active" %>class="selected"<% end %> onmouseover="$('duffels-submenu').show();" onmouseout="$('duffels-submenu').hide();">
				<a href="#">My Duffels <img style="vertical-align:middle;" src="/images/icon-down-arrow.png"/></a>
			</li>
			<!--<li id="tb-deals" <% if params[:tab] == "deals" %>class="selected"<% end %> onclick="location.search='tab=deals';$(this).addClassName('selected');$('tb-duffels').removeClassName('selected');$('tb-updates').removeClassName('selected'); $('loading-spinner').show(); return false;">
				<a href="#">My Travel Deals</a>
			</li>-->
			<span id="loading-spinner" style="display:none;">&nbsp;&nbsp;<img src="/images/ajax-loader.gif"></span>
			<ul class="submenu" id="duffels-submenu" style="display:none;" onmouseover="$('duffels-submenu').show();" onmouseout="$('duffels-submenu').hide();">
				<li onclick="location.search='tab=duffels-active';$('tb-duffels').addClassName('selected'); $('tb-updates').removeClassName('selected'); $('tb-deals').removeClassName('selected'); $('loading-spinner').show(); return false;"><a href="#">Active (<%= (@planned_trips.size+@no_date_trips.size) %>)</a></li>
				<li onclick="location.search='tab=duffels-previous';$('tb-duffels').addClassName('selected'); $('tb-updates').removeClassName('selected'); $('tb-deals').removeClassName('selected'); $('loading-spinner').show(); return false;"><a href="#">Previous (<%= @past_trips.size %>)</a></li>
				<li style="background: url(../images/icon-favorite.png) no-repeat 2px -121px;" onclick="location.search='tab=duffels-faves';$('tb-duffels').addClassName('selected'); $('tb-updates').removeClassName('selected'); $('tb-deals').removeClassName('selected'); $('loading-spinner').show(); return false;"><a href="#">Favorites (<%= @favorite_trips.size %>)</a></li>
			</ul>
		</ul>
	</div>
	
	<% if params[:tab] == "updates" %>	
		<%= render :partial => 'users/dashboard_partials/recent_updates' %>
	<% elsif params[:tab] == "deals" %>
		<%= render :partial => 'users/dashboard_partials/travel_deals' %>
	<% elsif params[:tab] == "duffels-previous" or params[:tab] == "duffels-faves" or params[:tab] == "duffels-active" %>
		<%= render :partial => 'users/dashboard_partials/my_duffels' %>
	<% else %> <!-- by default goes to updates tab -->
		<%= render :partial => 'users/dashboard_partials/recent_updates' %>
	<% end %>


    <div id="exploreDestinations">
      <h2>Popular Destinations <span class="right t15"><%= link_to "Browse More &raquo;</strong>", '/explore' %></span></h2>
      <ul>
        <li>
          <dl>
            <dd><a href="<%= na_city_url(:country_code => "US", :region => "NY", :city => "new-york")%>"><%= image_tag "cities/85x85/new-york.jpg", :class => "image1" %></a></dd>
            <dt><a href="<%= na_city_url(:country_code => "US", :region => "NY", :city => "new-york")%>">New York</a></dt>
          </dl>
        </li>
        <li>
          <dl>
            <dd><a href="<%= na_city_url(:country_code => "US", :region => "CA", :city => "san-francisco")%>"><%= image_tag "cities/85x85/san-francisco.jpg" %></a></dd>
            <dt><a href="<%= na_city_url(:country_code => "US", :region => "CA", :city => "san-francisco")%>">San Francisco</a></dt>
          </dl>
        </li>
        <li>
          <dl>
            <dd><a href="<%= na_city_url(:country_code => "US", :region => "CA", :city => "los-angeles")%>"><img src="../images/cities/85x85/los-angeles.jpg"/></a></dd>
            <dt><a href="<%= na_city_url(:country_code => "US", :region => "CA", :city => "los-angeles")%>">Los Angeles</a></dt>
          </dl>
        </li>
        <li>
          <dl>
            <dd><a href="<%= city_url(:country_code => "GB", :city => "london")%>"><img src="../images/cities/85x85/london.jpg"/></a></dd>
            <dt><a href="<%= city_url(:country_code => "GB", :city => "london")%>">London</a></dt>
          </dl>
        </li>
		<li>
          <dl>
            <dd><a href="<%= city_url(:country_code => "FR", :city => "paris")%>"><img src="../images/cities/85x85/paris.jpg"/></a></dd>
            <dt><a href="<%= city_url(:country_code => "FR", :city => "paris")%>">Paris</a></dt>
          </dl>
        </li>
      </ul>
    </div> <!-- #exploreDestinations -->

	<% unless @blog_rss.nil? %>
    <div id="newsfeed">
      <h2>News from Our Blog</h2>
      <ul>
        <li class="display">
          <dl>
            <dd><a href="<%= @blog_rss.items[0].link %>" target="_blank"><%= @blog_rss.items[0].title %></a> <cite><%= distance_of_time_in_words(@blog_rss.items[0].pubDate,Time.now) %> ago</cite></dd>
            <dd><a href="<%= @blog_rss.items[1].link %>" target="_blank"><%= @blog_rss.items[1].title %></a> <cite><%= distance_of_time_in_words(@blog_rss.items[1].pubDate,Time.now) %> ago</cite></dd>
            <dd><a href="<%= @blog_rss.items[2].link %>" target="_blank"><%= @blog_rss.items[2].title %></a> <cite><%= distance_of_time_in_words(@blog_rss.items[2].pubDate,Time.now) %> ago</cite></dd>
          </dl>
        </li>
      </ul>
    </div><!-- #newsfeed -->
	<% end %>
    
<!--    <div class="ad banner">
      	<table style="border: medium none ; margin: auto; height: 60px; text-align: center; -moz-background-clip: border; -moz-background-origin: padding; -moz-background-inline-policy: continuous; font-family: arial; font-style: normal; font-variant: normal; font-weight: 800; font-size: 11px; line-height: 12px; font-size-adjust: none; font-stretch: normal; -x-system-font: none; color: rgb(238, 238, 238);" width="468"><tbody><tr><td valign="middle">

		</td></tr></tbody></table>
    </div>--> <!-- .ad .banner -->

  </div> <!-- #mainContent -->

</div> <!-- #primary-inner -->

<script type="text/javascript"> 
  Event.observe(window, 'load', function() {
    <%= remote_function(:update => "travelDeals", :url => "/users/get_deals") %>
  });
</script>

<% if false #if params[:new] == "1" %>
<script type="text/javascript">
iBox.addEvent(window, 'load', function(){iBox.showURL('/site/tutorial_overview','',{width: '635', height: '440'})});
</script>
<% end %>

